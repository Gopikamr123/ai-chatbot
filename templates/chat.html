{% extends "base.html" %}
{% block title %}Chat ‚Äî Ai{% endblock %}
{% block page_title %}Chat{% endblock %}

{% block topbar_actions %}
<div style="display:flex;align-items:center;gap:12px;">
  {% if doc_count > 0 %}
    <span style="font-size:.78rem;color:var(--text-soft);background:rgba(217,97,71,.08);border:1px solid rgba(217,97,71,.18);padding:5px 12px;border-radius:20px;">
      üìÑ {{ doc_count }} document{% if doc_count != 1 %}s{% endif %} in knowledge base
    </span>
  {% else %}
    <a href="{{ url_for('add_document') }}" style="font-size:.78rem;color:var(--coral);background:rgba(217,97,71,.08);border:1px solid rgba(217,97,71,.18);padding:5px 12px;border-radius:20px;text-decoration:none;">
      ‚ö†Ô∏è No documents yet ‚Äî Add one
    </a>
  {% endif %}
  <form method="POST" action="{{ url_for('clear_chat') }}"
        onsubmit="return confirm('Clear all chat history?')">
    <button type="submit" class="btn btn-ghost">
      <svg viewBox="0 0 24 24" style="width:15px;height:15px;stroke:currentColor;fill:none;stroke-width:2;"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>
      Clear
    </button>
  </form>
</div>
{% endblock %}

{% block extra_styles %}
<style>
  .chat-layout { display:flex; flex-direction:column; height:calc(100vh - 130px); }

  .chat-messages {
    flex:1; overflow-y:auto; padding:8px 0 24px;
    display:flex; flex-direction:column; gap:20px;
    scrollbar-width:thin; scrollbar-color:rgba(200,170,160,.4) transparent;
  }

  .msg-row { display:flex; gap:12px; max-width:820px; }
  .msg-row.user      { align-self:flex-end;   flex-direction:row-reverse; }
  .msg-row.assistant { align-self:flex-start; }

  .msg-avatar {
    width:34px; height:34px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    font-size:.75rem; font-weight:600; flex-shrink:0; margin-top:2px;
  }
  .msg-avatar.user-av { background:linear-gradient(135deg,var(--peach),var(--lavender)); color:white; }
  .msg-avatar.ai-av   { background:linear-gradient(135deg,var(--coral),var(--peach));    color:white; font-size:.6rem; }

  .msg-bubble {
    padding:14px 18px; border-radius:18px;
    font-size:.88rem; line-height:1.7; max-width:620px;
  }
  .msg-row.user .msg-bubble {
    background:var(--coral); color:white;
    border-bottom-right-radius:6px;
    box-shadow:0 4px 16px rgba(217,97,71,.25);
  }
  .msg-row.assistant .msg-bubble {
    background:var(--glass); backdrop-filter:blur(12px);
    border:1px solid var(--glass-border); color:var(--warm-dark);
    border-bottom-left-radius:6px;
  }

  /* Render *text* as italic/bold in AI messages */
  .msg-bubble em   { font-style:italic; color:var(--text-mid); }
  .msg-bubble strong { font-weight:600; }

  .sources-row { display:flex; gap:6px; flex-wrap:wrap; margin-top:10px; }
  .source-badge {
    display:inline-flex; align-items:center; gap:5px;
    padding:4px 10px; border-radius:20px; font-size:.72rem; font-weight:500;
  }
  .source-badge.doc { background:rgba(217,97,71,.1); color:var(--coral); border:1px solid rgba(217,97,71,.2); }
  .source-badge.web { background:rgba(80,140,220,.1); color:#3a6ab0;     border:1px solid rgba(80,140,220,.2); }
  .source-badge svg { width:11px; height:11px; stroke:currentColor; fill:none; stroke-width:2; }

  .msg-time { font-size:.7rem; color:var(--text-soft); margin-top:5px; padding:0 4px; }

  /* Typing */
  .typing-indicator { display:none; }
  .typing-indicator.show { display:flex; }
  .typing-dots { display:flex; gap:4px; align-items:center; padding:14px 18px; }
  .typing-dots span {
    width:7px; height:7px; border-radius:50%; background:var(--text-soft);
    animation:typingBounce 1.2s ease-in-out infinite;
  }
  .typing-dots span:nth-child(2) { animation-delay:.2s; }
  .typing-dots span:nth-child(3) { animation-delay:.4s; }
  @keyframes typingBounce {
    0%,80%,100% { transform:translateY(0); opacity:.5; }
    40%          { transform:translateY(-6px); opacity:1; }
  }

  /* Input */
  .chat-input-area { border-top:1px solid rgba(200,180,170,.2); padding-top:16px; }
  .chat-input-row  { display:flex; gap:10px; align-items:flex-end; }
  .chat-input {
    flex:1; padding:14px 18px; border-radius:18px;
    background:rgba(255,255,255,.55); border:1px solid rgba(200,180,170,.4);
    font-family:'DM Sans',sans-serif; font-size:.9rem; color:var(--warm-dark);
    outline:none; resize:none; transition:border-color .2s,box-shadow .2s;
    backdrop-filter:blur(8px); max-height:140px;
  }
  .chat-input:focus { border-color:var(--coral); box-shadow:0 0 0 3px rgba(217,97,71,.1); }
  .send-btn {
    width:46px; height:46px; border-radius:50%; border:none;
    background:var(--coral); color:white; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    transition:transform .2s,box-shadow .2s;
    box-shadow:0 4px 14px rgba(217,97,71,.35); flex-shrink:0;
  }
  .send-btn:hover    { transform:scale(1.08); box-shadow:0 6px 20px rgba(217,97,71,.45); }
  .send-btn:disabled { background:var(--text-soft); box-shadow:none; transform:none; cursor:not-allowed; }
  .send-btn svg { width:18px; height:18px; stroke:white; fill:none; stroke-width:2; }
  .input-hint { font-size:.74rem; color:var(--text-soft); margin-top:8px; text-align:center; }

  /* Empty state */
  .empty-chat {
    flex:1; display:flex; flex-direction:column;
    align-items:center; justify-content:center; text-align:center; gap:10px;
  }
  .empty-chat-icon {
    width:60px; height:60px; border-radius:20px;
    background:linear-gradient(135deg,rgba(217,97,71,.12),rgba(201,192,216,.2));
    display:flex; align-items:center; justify-content:center; margin-bottom:4px;
  }
  .empty-chat-icon svg { width:28px; height:28px; stroke:var(--coral); fill:none; stroke-width:1.5; }
  .empty-chat h3 { font-family:'Cormorant Garamond',serif; font-size:1.5rem; font-weight:300; }
  .empty-chat p  { font-size:.85rem; color:var(--text-soft); max-width:340px; line-height:1.6; }
  .suggestion-chips { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:8px; }
  .chip {
    padding:7px 14px; border-radius:20px; font-size:.78rem;
    background:rgba(255,255,255,.5); border:1px solid rgba(200,180,170,.4);
    color:var(--text-mid); cursor:pointer; transition:all .2s;
  }
  .chip:hover { background:rgba(217,97,71,.08); border-color:rgba(217,97,71,.25); color:var(--coral); }
</style>
{% endblock %}

{% block content %}
<div class="chat-layout">

  <div class="chat-messages" id="chatMessages">
    {% if history %}
      {% for msg in history %}
      <div class="msg-row user">
        <div class="msg-avatar user-av">{{ current_user.username[0].upper() }}</div>
        <div>
          <div class="msg-bubble">{{ msg.question }}</div>
          <div class="msg-time" style="text-align:right;">{{ msg.created_at.strftime('%H:%M') }}</div>
        </div>
      </div>
      <div class="msg-row assistant">
        <div class="msg-avatar ai-av">AI</div>
        <div>
          <div class="msg-bubble" id="hist-{{ msg.id }}">{{ msg.answer }}</div>
          {% if msg.source_type == 'web' %}
          <div class="sources-row">
            <span class="source-badge web">
              <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10z"/></svg>
              Web search
            </span>
          </div>
          {% elif msg.source_type == 'document' %}
          <div class="sources-row">
            <span class="source-badge doc">
              <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
              From your documents
            </span>
          </div>
          {% endif %}
          <div class="msg-time">{{ msg.created_at.strftime('%H:%M') }}</div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="empty-chat" id="emptyState">
        <div class="empty-chat-icon">
          <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        </div>
        <h3>Chat with your documents</h3>
        <p>
          {% if doc_count > 0 %}
            You have {{ doc_count }} document{% if doc_count != 1 %}s{% endif %} ready.
            Ask me anything about them!
          {% else %}
            Add documents first, then ask me anything about them.
          {% endif %}
        </p>
        {% if doc_count > 0 %}
        <div class="suggestion-chips">
          <div class="chip" onclick="useChip(this)">Summarise my documents</div>
          <div class="chip" onclick="useChip(this)">What topics are covered?</div>
          <div class="chip" onclick="useChip(this)">What are the key points?</div>
        </div>
        {% endif %}
      </div>
    {% endif %}

    <!-- Typing indicator -->
    <div class="msg-row assistant typing-indicator" id="typingIndicator">
      <div class="msg-avatar ai-av">AI</div>
      <div class="msg-bubble" style="padding:0;background:var(--glass);border:1px solid var(--glass-border);">
        <div class="typing-dots"><span></span><span></span><span></span></div>
      </div>
    </div>
  </div>

  <!-- Input -->
  <div class="chat-input-area">
    <div class="chat-input-row">
      <textarea id="questionInput" class="chat-input" rows="1"
                placeholder="Ask anything about your documents‚Ä¶"></textarea>
      <button id="sendBtn" class="send-btn" onclick="sendMessage()">
        <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      </button>
    </div>
    <div class="input-hint">Enter to send &nbsp;¬∑&nbsp; Shift+Enter for new line</div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const input   = document.getElementById('questionInput');
  const sendBtn = document.getElementById('sendBtn');
  const msgs    = document.getElementById('chatMessages');
  const typing  = document.getElementById('typingIndicator');
  const empty   = document.getElementById('emptyState');

  // Render **bold** and *italic* and line breaks in AI messages
  function renderMarkdown(text) {
    return text
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      .replace(/\n/g, '<br>');
  }

  // Apply to history messages on load
  document.querySelectorAll('[id^="hist-"]').forEach(el => {
    el.innerHTML = renderMarkdown(el.textContent);
  });

  // Auto-resize textarea
  input.addEventListener('input', () => {
    input.style.height = 'auto';
    input.style.height = Math.min(input.scrollHeight, 140) + 'px';
  });
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });

  function scrollToBottom() { msgs.scrollTop = msgs.scrollHeight; }
  function timeNow() { return new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
  function useChip(el) { input.value = el.textContent; input.focus(); }

  function addMessage(role, text, sources, sourceType) {
    const isUser = role === 'user';
    const initial = "{{ current_user.username[0].upper() }}";

    let sourcesHtml = '';
    if (!isUser && sources && sources.length) {
      sourcesHtml = '<div class="sources-row">';
      sources.forEach(s => {
        if (s.type === 'web') {
          const href = s.url ? `href="${s.url}" target="_blank"` : '';
          sourcesHtml += `<a ${href} class="source-badge web" style="text-decoration:none;">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10z"/></svg>
            ${s.title.length > 35 ? s.title.slice(0,35)+'‚Ä¶' : s.title}</a>`;
        } else {
          sourcesHtml += `<span class="source-badge doc">
            <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            ${s.title}</span>`;
        }
      });
      sourcesHtml += '</div>';
    }
    // If no sources but doc type, show generic badge
    if (!isUser && (!sources || !sources.length) && sourceType === 'document') {
      sourcesHtml = `<div class="sources-row"><span class="source-badge doc">
        <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        From your documents</span></div>`;
    }

    const html = `
      <div class="msg-row ${isUser ? 'user' : 'assistant'}">
        <div class="msg-avatar ${isUser ? 'user-av' : 'ai-av'}">${isUser ? initial : 'AI'}</div>
        <div>
          <div class="msg-bubble">${isUser ? text.replace(/\n/g,'<br>') : renderMarkdown(text)}</div>
          ${!isUser ? sourcesHtml : ''}
          <div class="msg-time" style="${isUser?'text-align:right;':''}">${timeNow()}</div>
        </div>
      </div>`;

    typing.insertAdjacentHTML('beforebegin', html);
    scrollToBottom();
  }

  async function sendMessage() {
    const q = input.value.trim();
    if (!q) return;
    if (empty) empty.style.display = 'none';

    addMessage('user', q);
    input.value = '';
    input.style.height = 'auto';
    sendBtn.disabled = true;
    typing.classList.add('show');
    scrollToBottom();

    try {
      const fd = new FormData();
      fd.append('question', q);
      const res  = await fetch('/chat/ask', {method:'POST', body:fd});
      const data = await res.json();
      typing.classList.remove('show');

      if (data.error) {
        addMessage('assistant', '‚ö†Ô∏è ' + data.error, [], 'none');
      } else {
        addMessage('assistant', data.answer, data.sources || [], data.source_type || 'document');
      }
    } catch(err) {
      typing.classList.remove('show');
      addMessage('assistant', '‚ö†Ô∏è Something went wrong. Please try again.', [], 'none');
    } finally {
      sendBtn.disabled = false;
      input.focus();
    }
  }

  scrollToBottom();
</script>
{% endblock %}
